<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-localstorage/iron-localstorage.html">
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">

<script src="../bower_components/lodash/lodash.js"></script>
<script src="../bower_components/evrythng/dist/evrythng.js"></script>
<script src="../bower_components/mqttjs-browserified/dist/mqtt.js"></script>
<script src="../bower_components/evrythng-ws/dist/evrythng-ws.js"></script>
<script src="../bower_components/evrythng-hub/dist/evrythng-hub.js"></script>
<script src="../bower_components/time-elements/time-elements.js"></script>

<link rel="import" href="th-core.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="th-iconset.html">
<link rel="import" href="th-login.html">
<link rel="import" href="th-user.html">

<dom-module id="th-app">
  <template>
    <style include="iron-flex shared-styles">
      :host {
        --primary-color: var(--paper-grey-900);
        --secondary-color: black;

        display: block;
      }
    </style>

    <iron-localstorage name="th-settings" value="{{settings}}" on-iron-localstorage-load-empty="_setDefaultSettings"></iron-localstorage>

    <app-drawer-layout fullbleed hidden$="[[!_isReady(app, user)]]">
      <app-location route="{{route}}"></app-location>
      <app-route
        route="{{route}}"
        pattern="/:page"
        data="{{routeData}}"
        tail="{{subroute}}"></app-route>

      <!-- Drawer content -->
      <app-drawer>
        <container>

          <section class="header-logo">
            <img src="/images/evt-logo-inverted.png" alt="EVRYTHNG" sizing="cover"></iron-image>
          </section>
          <hr>

          <section>
            <iron-selector selected="[[page]]" attr-for-selected="name" role="navigation">
              <a class="drawer-item" name="thngs" href="/thngs">
                <iron-icon icon="th:thng"></iron-icon><span>Thngs</span>
              </a>
              <a class="drawer-item" name="collections" href="/collections">
                <iron-icon icon="th:collection"></iron-icon><span>Collections</span>
              </a>

              <hr>
              <a class="drawer-item" name="settings" href="/settings">
                <iron-icon icon="settings"></iron-icon><span>Settings</span>
              </a>
            </iron-selector>
          </section>

          <section>
            <span class="drawer-item target-environment" on-tap="_toggleTargetEnvironment">
              <iron-icon id="targetEnvironmentIcon"></iron-icon>
              <span>Cloud</span>
              <paper-toggle-button checked="{{settings.remote}}"></paper-toggle-button>
            </span>
          </section>

          <footer>
            <a href="https://evrythng.com" class="th-powered-by">
              <span>Powered by</span><img class="mini-logo" src="/images/evt-logo-mini.jpg" alt="EVRYTHNG">
            </a>
          </footer>
        </container>
      </app-drawer>

      <!-- Main content -->
      <app-header-layout has-scrolling-region>
        <app-header condensed reveals effects="waterfall">
          <app-toolbar>
            <paper-icon-button icon="menu" drawer-toggle></paper-icon-button>
            <span class="flex"></span>
            <th-user user="{{user}}" on-logout="_logout"></th-user>
          </app-toolbar>
        </app-header>

        <iron-pages
            id="thPages"
            selected="[[page]]"
            attr-for-selected="name"
            fallback-selection="view404"
            role="main">
          <th-thngs name="thngs" user="{{user}}" route="{{subroute}}"></th-thngs>
          <th-collections name="collections" user="{{user}}" route="{{subroute}}"></th-collections>
          <th-settings name="settings" settings="{{settings}}" route="{{subroute}}"></th-settings>
          <th-view404 name="view404"></th-view404>
        </iron-pages>
      </app-header-layout>
    </app-drawer-layout>

    <th-login id="loginForm" hidden$="[[_isReady(app, user)]]" loading="{{loading}}" on-login="_onLogin"></th-login>
  </template>

  <script>
    Polymer({
      is: 'th-app',

      properties: {
        page: {
          type: String,
          reflectToAttribute: true,
          observer: '_onPageChanged'
        },

        app: Object,

        user: {
          type: Object,
          observer: '_onUserChanged'
        }
      },

      observers: [
        'setupEVT(settings)',
        '_routePageChanged(routeData.page)',
        '_onTargetEnvironmentChange(settings.remote)'
      ],

      behaviors: [
        TH.behaviors.showToast
      ],

      defaultSettings: {
        apiKey: '1olb2yZkSav8VXpCu287BtFEG3oXx13eOgZCb0VAilM3jri0Rz3aqzzWMPe6paZMXNDbTPVELL9jzig3',

        apiUrl: 'https://api.evrythng.com',
        localhostApiUrl: 'http://192.168.0.12:8080',

        wsApiUrl: 'wss://ws.evrythng.com:443/mqtt',
        wsLocalhostApiUrl: 'ws://localhost:4000/mqtt',

        hubTimeout: 1000,
        remote: true
      },

      ready: function() {
        // Initialise EVT.js after
        // settings are read from storage and all
        // children are ready.
        this.async(function() {
          this.initEVT();
          this.initApp();
        });
      },

      initEVT: function() {
        if (this.settings) {
          EVT.use(EVT.WS);
          EVT.use(EVT.Hub);

          this.setupEVT(this.settings);
        }
      },

      setupEVT: function(settings) {
        if (settings) {
          EVT.WS.setup({
            apiUrl: settings.wsApiUrl
          });

          EVT.Hub.setup({
            httpApiUrl: settings.localhostApiUrl,
            wsApiUrl: settings.wsLocalhostApiUrl,
            timeout: settings.hubTimeout,
            remote: settings.remote
          });

          EVT.setup(settings);
        }
      },

      initApp: function() {
        var scope = this;
        var app = new EVT.App({
          apiKey: this.settings.apiKey
        });

        app.$init.then(function() {
            return scope._initFacebook(app.socialNetworks.facebook.appId)
              .then(function(response) {
                if (response.status === 'connected') {
                  return scope._authFacebook(response, app);
                } else {
                  return response;
                }
              });
          })
          .then(function(response) {
            if (response.user) {
              scope.set('user', response.user);
            } else {
              scope.$.loginForm.open();
            }

            scope.set('app', app);
            scope.set('loading', false);
          });
      },

      _isReady: function(app, user) {
        return Boolean(app && user);
      },

      _onUserChanged: function(user) {
        this.$.thPages.fire('iron-resize');

        if (user) {
          this.$.loginForm.close();
        } else {
          this.$.loginForm.open();
        }
      },

      _routePageChanged: function(page) {
        this.page = page || 'thngs';
      },

      _onPageChanged: function(page) {
        // Load page import on demand. Show 404 page if fails
        var resolvedPageUrl = this.resolveUrl('th-' + page + '.html');

        this.importHref(resolvedPageUrl, null, this._showPage404, true);
      },

      _showPage404: function() {
        this.page = 'view404';
      },

      _toggleTargetEnvironment: function() {
        this.set('settings.remote', !this.settings.remote);
      },

      _onTargetEnvironmentChange: function(isRemoteEnabled) {
        this.$.targetEnvironmentIcon.icon = isRemoteEnabled ? 'th:cloud-on' : 'th:cloud-off';
      },

      _onSettingsChange: function(e) {
        var settings = e.detail;
        var fields = [ 'apiKey', 'apiUrl', 'localhostUrl', 'wsApiUrl', 'wsLocalhostUrl' ];

        fields.forEach(function(field) {
          this.set('settings.' + field, settings[field]);
        }, this);
      },

      _onLogin: function(e) {
        this._login(e.detail);
      },

      _login: function(config) {
        var scope = this;

        scope.$.app.login(config)
          .catch(function() {
            scope.showToast('Failed to login');
          });
      },

      _logout: function() {
        var scope = this;

        scope.$.app.logout()
          .catch(function() {
            scope.showToast('Failed to logout');
          });
      },

      _setDefaultSettings: function() {
        this.settings = this.defaultSettings;
      },

      _initFacebook: function(appId) {
        var scope = this;

        return new Promise(function(resolve, reject) {
          (function(d, s, id){
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) return;
            js = d.createElement(s); js.id = id;
            js.src = "//connect.facebook.net/en_US/sdk.js";
            fjs.parentNode.insertBefore(js, fjs);
          }(document, 'script', 'facebook-jssdk'));

          window.fbAsyncInit = function() {
            FB.init({
              appId: appId,
              status: true,
              cookie: true,
              version: 'v2.7'
            });

            FB.getLoginStatus(function (response) {
              if (response.status === 'connected') {
                FB.api('/me', {
                  fields: 'id,first_name,last_name,gender,link,picture,locale,name,timezone,updated_time,verified'
                }, function (userInfo) {
                  resolve(scope.mixin(response, { user: userInfo }));
                });
              } else {
                resolve(response);
              }
            });
          };
        });
      },

      _authFacebook: function(response, app) {
        var scope = this;

        return EVT.api({
          url: '/auth/facebook',
          method: 'post',
          data: {
            access: {
              token: response.authResponse.accessToken
            }
          }
        }).then(function(access) {
          var user = new EVT.User({
            id: access.evrythngUser,
            apiKey: access.evrythngApiKey
          }, app);

          scope.mixin(user, {
            facebook: response.user
          });

          response.user = user;

          return user.update();
        }).then(function() {
          return response;
        });
      },
    });
  </script>
</dom-module>
