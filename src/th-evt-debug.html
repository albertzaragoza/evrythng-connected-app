<link rel="import" href="../bower_components/paper-material/paper-material.html">
<link rel="import" href="../bower_components/iron-localstorage/iron-localstorage.html">
<link rel="import" href="../bower_components/iron-list/iron-list.html">

<link rel="import" href="shared-styles.html">
<link rel="import" href="th-json-renderer.html">

<dom-module id="th-evt-debug">
  <template>
    <style include="shared-styles">
      :host {
        @apply(--layout-block);
        @apply(--layout-fixed-bottom);
        @apply(--dark-theme);

        transition: all .3s ease;
        transform: translateY(110%);

        --json-theme-link: var(--paper-grey-400);
        --json-theme-disclosure: var(--paper-grey-400);
        --json-theme-syntax: var(--paper-grey-600);
        --json-theme-string: var(--paper-green-300);
        --json-theme-number: var(--paper-blue-400);
        --json-theme-boolean: var(--paper-amber-500);
        --json-theme-key: var(--paper-grey-400);
        --json-theme-keyword: var(--paper-amber-500);

        --text-base-color: var(--paper-grey-50);
        --background-base-color: var(--paper-grey-900);

        --code-font: {
          font-family: monospace;
        }
      }

      :host(.opened) {
        transform: translateY(0%);
      }

      container {
        @apply(--layout-vertical);
        @apply(--code-font);

        display: block;

        height: 50vh;
        overflow: auto;

        background-color: var(--background-base-color);
        color: var(--text-base-color);


        box-shadow: 0 -20px 70px rgba(0, 0, 0, .6);
      }

      th-json-renderer {
        margin-bottom: var(--app-unit-xs);
      }

      .tools {
        position: absolute;
        right: 0;
        top: 0;

        text-align: right;
        color:  var(--text-base-color);
        padding: var(--app-unit-md) var(--app-unit-lg);
      }

      .stats {
        @apply(--code-font);
      }

    </style>

    <container id="scroller">
      <template is="dom-repeat" items="{{events}}">
        <div>
          <span>&gt;</span><span>{{item.type}}</span>
          <span>{{item.payload.url}}</span>
          <th-json-renderer json="[[item.payload]]"></th-json-renderer>
        </div>
      </template>
    </container>

    <div class="tools">
      <div class="toolbar">
        <paper-icon-button icon="th:eraser" on-tap="clean"></paper-icon-button>
        <paper-icon-button icon="close" on-tap="close"></paper-icon-button>
      </div>
      <div class="stats">
        <span>total: </span><span>{{total}}</span>
      </div>
    </div>

    <iron-localstorage name="th-devtool-opened" value="{{opened}}" on-iron-localstorage-load-empty="close"></iron-localstorage>

  </template>
  <script>
    Polymer({
      is: 'th-evt-debug',

      properties: {
        opened: {
          type: Boolean,
          observer: '_onOpenedChanged'
        },

        events: {
          type: Array,
          value: []
        },

        total: {
          type: Number,
          value: 0
        }
      },

      ready: function() {
        if (window.EVT) {
          this.EVT = window.EVT;
          this.patchEVT();
        }
      },

      // TODO: Remove when fix released
      patchEVT: function() {
        var scope = this;
        var original = EVT.api;

        EVT.api = function(options) {
          options = options || {};
          options.interceptors = options.interceptors || [];
          options.interceptors.push({
            request: scope.logRequest.bind(scope),
            response: scope.logResponse.bind(scope)
          });

          return original(options);
        };
      },

      logRequest: function(opts) {
        this.inc('total', +1);
        this.log({
          type: 'REQUEST',
          payload: opts
        });
      },

      logResponse: function(opts) {
        this.log({
          type: 'RESPONSE',
          payload: opts
        });

        return opts;
      },

      inc: function(vr, inc) {
        this.set(vr, this[vr] + inc);
      },

      log: function(obj) {
        this.push('events', obj);
        this.ensureFull();

        this.async(function() {
          this.$.scroller.scrollTop = this.$.scroller.scrollHeight;
        });
      },

      ensureFull: function() {
        if (this.events.length > 100) {
          this.splice('events', this.events.length - 1, 1);
        }
      },

      clean: function() {
        this.splice('events', 0, this.events.length);
        this.set('total', 0);
      },

      close: function() {
        this.set('opened', false);
      },

      _onOpenedChanged: function(opened) {
        this.classList.toggle('opened', opened);
        this.fire('state-changed', opened);
      }
    });
  </script>
</dom-module>